<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VegDelight - Checkout</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
 font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
 background:linear-gradient(to bottom right,#dcfce7,#bbf7d0);
 min-height:100vh;
}
nav{background:#fff;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,.1);}
main{max-width:80rem;margin:auto;padding:2rem 1rem;}
.container{display:grid;grid-template-columns:1fr 1fr;gap:2rem;}
label{display:block;margin:.6rem 0 .3rem;font-weight:500;}
input,textarea{
 width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem;
}
textarea{min-height:90px;}
button{
 background:#16a34a;color:#fff;border:none;padding:.8rem;border-radius:.5rem;
 font-weight:600;cursor:pointer;
}
.secondary-btn{
 background:#e5e7eb;color:#111;margin-top:.4rem;
}
#map{height:240px;border-radius:10px;margin-top:.5rem;}
.summary-box{background:#f9fafb;padding:1.5rem;border-radius:.75rem;}
.summary-item{display:flex;justify-content:space-between;margin-bottom:.6rem;}
.total{display:flex;justify-content:space-between;font-size:1.3rem;font-weight:700;margin-top:1rem;}
.success{display:none;background:#fff;padding:3rem;border-radius:1rem;text-align:center;}
.success.show{display:block;}
@media(max-width:768px){.container{grid-template-columns:1fr;}}
</style>
</head>

<body onload="initCheckout()">

<nav>
<h2>VegDelight</h2>
</nav>

<main>

<div id="formContainer">
<div class="container">

<!-- LEFT -->
<div>
<h2>Delivery Details</h2>

<form onsubmit="handleCheckout(event)">
<label>Full Name</label>
<input id="customerName" required>

<label>Email</label>
<input id="customerEmail" required>

<label>Phone Number</label>
<input id="phoneNumber" required>

<label>Delivery Address</label>
<textarea id="deliveryAddress" placeholder="Address will auto-fill..." required></textarea>

<button type="button" class="secondary-btn" onclick="useCurrentLocation()">
üìç Use Current Location
</button>

<div id="map"></div>

<p id="distanceText"></p>
<p id="deliveryFeeText"></p>

<button type="submit" style="margin-top:1rem;width:100%">Place Order</button>
</form>
</div>

<!-- RIGHT -->
<div>
<h2>Order Summary</h2>
<div class="summary-box">
<div id="summaryItems"></div>
<div class="total">
<span>Total</span>
<span id="totalAmount">‚Çπ0</span>
</div>
</div>
</div>

</div>
</div>

<div class="success" id="successMessage">
<h2>Order Placed Successfully</h2>
<p>Order ID: <span id="orderId"></span></p>
<button onclick="goToMenu()">Back to Menu</button>
</div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBXsEzzDtXO3nuNaCnqerAGEzrZqFVbB4U",
  authDomain: "dvegdelight.firebaseapp.com",
  projectId: "dvegdelight",
  storageBucket: "dvegdelight.firebasestorage.app",
  messagingSenderId: "184865686236",
  appId: "1:184865686236:web:560c5b038cb1584e9caa19"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* STATE */
let cart = [];

/* INIT */
window.initCheckout = function () {
  const email = localStorage.getItem("userEmail");

  if (!email) {
    location.href = "login.html";
    return;
  }

  const savedCart = localStorage.getItem("cart");
  if (!savedCart) {
    alert("Your cart is empty");
    location.href = "customer.html";
    return;
  }

  cart = JSON.parse(savedCart);
  if (!Array.isArray(cart) || !cart.length) {
    alert("Your cart is empty");
    location.href = "customer.html";
    return;
  }

  customerEmail.value = email;
  renderSummary();
};

/* SUMMARY */
function renderSummary() {
  summaryItems.innerHTML = "";
  let total = 0;

  cart.forEach(item => {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    const itemTotal = price * qty;
    total += itemTotal;

    summaryItems.innerHTML += `
      <div class="summary-item">
        <div>
          <div class="item-name">${item.name}</div>
          <div class="item-qty">Qty: ${qty}</div>
        </div>
        <div class="item-total">‚Çπ${itemTotal.toFixed(2)}</div>
      </div>
    `;
  });

  totalAmount.textContent = "‚Çπ" + total.toFixed(2);
}

/* PLACE ORDER ‚Äî ADMIN SAFE */
window.handleCheckout = async function (e) {
  e.preventDefault();

  const items = cart.map(i => ({
    name: i.name,
    price: Number(i.price || 0),
    quantity: Number(i.qty || 0)
  }));

  const totalAmountValue = items.reduce(
    (sum, i) => sum + i.price * i.quantity,
    0
  );

  const order = {
    customer_name: customerName.value,
    customer_email: customerEmail.value,
    phone_number: phoneNumber.value,
    delivery_address: deliveryAddress.value,

    items: items,
    total_amount: totalAmountValue,
    currency: "INR",

    status: "pending",
    created_at: serverTimestamp()
  };

  const ref = await addDoc(collection(db, "orders"), order);

  localStorage.removeItem("cart");

  orderId.textContent = ref.id;
  formContainer.classList.add("hide");
  successMessage.classList.add("show");
};

/* NAV */
window.goBack = () => location.href = "customer.html";
window.goToMenu = () => location.href = "customer.html";
</script>


</body>
</html>
